---
title: "Calling SPLITT from an R-package"
author: "Venelin Mitov"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Calling SPLITT from an R-package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


In this tutorial, I show step by step how to build an R-package that is using the `AbcPMM` `TraversalSpecificaton`-class to calculate the log-likelihood of the PMM model on a given tree, trait-data and model parameters. The code for this example is available from the following directory in the [SPLITT github repository](https://github.com/venelin/SPLITT): 

[PMMUsingSPLITT-R-package](https://github.com/venelin/SPLITT/tree/master/PMMUsingSPLITT-R-package) 

This example is based on the R-package Rcpp, which provides a nice way to expose the functionality of a C++ class to an R script or an R-package. The PMMUsingSPLITT package provides an example of how to create a `TraversalTask` object and to invoke  its method `TraverseTree` from R. Specifically, this is based on Rcpp modules as described in Chapter 7 of the following book:

Eddelbuettel, D. (2013). Seamless R and C++ Integration with Rcpp. New York, NY: Springer Science & Business Media. http://doi.org/10.1007/978-1-4614-6868-4 


# What is in the PMMUsingSPLITT R-package?

The PMMUsingSPLITT R-package follows the directory structure of a typical R-package including C++ code. The package has been initialized using a call to the function `Rcpp::Rcpp.package.skeleton`:

```{r, eval=FALSE}
Rcpp::Rcpp.package.skeleton("PMMUsingSPLITT")
```

Then, the created directory PMMUsingSPLITT has been manually renamed to PMMUsingSPLITT-R-package and the default example R and C++ files have been replaced by the code files specific for the PMM log-likelihood calculation. Here are the final  directories and files found in the package:

```{bash, eval=FALSE, echo=TRUE}
ls -Rlt PMMUsingSPLITT-R-package
```

```{bash, eval=FALSE, echo=TRUE}
total 24
drwxr-xr-x  8 vmitov  1029  272 Nov  7 22:54 src
drwxr-xr-x  5 vmitov  1029  170 Nov  7 22:53 R
drwxr-xr-x  7 vmitov  1029  238 Nov  7 22:53 man
drwxr-xr-x  3 vmitov  1029  102 Nov  7 22:53 tests
-rw-r--r--  1 vmitov  1029  643 Nov  7 14:45 DESCRIPTION
-rw-r--r--  1 vmitov  1029  235 Nov  7 14:45 NAMESPACE
-rw-r--r--  1 vmitov  1029  420 Nov  7 11:27 Read-and-delete-me

./src:
total 224
-rw-r--r--  1 vmitov  1029   2658 Nov  7 16:11 RCPP__AbcPMM.cpp
-rw-r--r--  1 vmitov  1029   3462 Nov  7 16:10 AbcPMM.h
-rw-r--r--  1 vmitov  1029    590 Nov  7 14:47 RcppExports.cpp
-rw-r--r--  1 vmitov  1029   1318 Nov  7 11:54 NumericTraitData.h
-rw-r--r--  1 vmitov  1029  93322 Nov  7 11:47 SPLITT.h
-rw-r--r--  1 vmitov  1029   3048 Nov  7 11:35 Makevars

./R:
total 32
-rw-r--r--  1 vmitov  1029  5347 Nov  7 14:52 MiniBenchmark.R
-rw-r--r--  1 vmitov  1029  3713 Nov  7 14:40 PMM.R
-rw-r--r--  1 vmitov  1029  1135 Nov  7 11:43 zzz.R

./man:
total 40
-rw-r--r--  1 vmitov  1029   712 Nov  7 11:58 MiniBenchmark.Rd
-rw-r--r--  1 vmitov  1029   573 Nov  7 11:58 NewPMMCppObject.Rd
-rw-r--r--  1 vmitov  1029   757 Nov  7 11:58 PMMLogLik.Rd
-rw-r--r--  1 vmitov  1029  1549 Nov  7 11:58 PMMLogLikCpp.Rd
-rw-r--r--  1 vmitov  1029   842 Nov  7 11:27 PMMUsingSPLITT-package.Rd

./tests:
total 0
drwxr-xr-x  4 vmitov  1029  136 Nov  7 14:12 testthat

./tests/testthat:
total 16
-rw-r--r--  1 vmitov  1029  317 Nov  7 14:56 test-PMMLogLikelihoodSpeed.R
-rw-r--r--  1 vmitov  1029  582 Nov  7 14:13 test-PMMLogLikelihoodValue.R
```





## Writing a factory function for the `ParallelPruningAbcPMM` traversal task

In 

```{Rcpp, eval=FALSE, echo=TRUE}
/**
  *  RCPP_Tree.cpp
  *  SPLITT
  *
  * Copyright 2017 Venelin Mitov
  *
  * This file is part of SPLITT: a generic C++ library for Serial and Parallel
  * Lineage Traversal of Trees.
  *
  * SPLITT is free software: you can redistribute it and/or modify
  * it under the terms of the GNU Lesser General Public License as
  * published by the Free Software Foundation, either version 3 of
  * the License, or (at your option) any later version.
  *
  * SPLITT is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU Lesser General Public License for more details.
  *
  * You should have received a copy of the GNU Lesser General Public
  * License along with SPLITT.  If not, see
  * <http://www.gnu.org/licenses/>.
  *
  * @author Venelin Mitov
  */

#include <RcppArmadillo.h>
#include <R_ext/Rdynload.h>
    
#include "./AbcPMM.h"
    
// [[Rcpp::plugins("cpp11")]]
// [[Rcpp::plugins(openmp)]]
// [[Rcpp::depends(RcppArmadillo)]]

using namespace SPLITT;
using namespace PMMUsingSPLITT;

typedef TraversalTask< AbcPMM<OrderedTree<uint, double>> > ParallelPruningAbcPMM;


ParallelPruningAbcPMM* CreateParallelPruningAbcPMM(
    Rcpp::List const& tree, vec const& x) {
  arma::umat branches = tree["edge"];
  uvec br_0 = arma::conv_to<uvec>::from(branches.col(0));
  uvec br_1 = arma::conv_to<uvec>::from(branches.col(1));
  vec t = Rcpp::as<vec>(tree["edge.length"]);
  uint num_tips = Rcpp::as<Rcpp::CharacterVector>(tree["tip.label"]).size();
  uvec node_names = Seq(uint(1), num_tips);
  typename ParallelPruningAbcPMM::DataType data(node_names, x);
  return new ParallelPruningAbcPMM(br_0, br_1, t, data);
}

RCPP_EXPOSED_CLASS_NODECL(ParallelPruningAbcPMM::AlgorithmType)
  
RCPP_MODULE(PMMUsingSPLITT__AbcPMM) {
  Rcpp::class_<ParallelPruningAbcPMM::AlgorithmType::ParentType> ( "PMMUsingSPLITT__AbcPMM__TraversalAlgorithm" )
    .property( "VersionOPENMP", &ParallelPruningAbcPMM::AlgorithmType::ParentType::VersionOPENMP )
    .property( "NumOmpThreads", &ParallelPruningAbcPMM::AlgorithmType::ParentType::NumOmpThreads )
  ;
  Rcpp::class_<ParallelPruningAbcPMM::AlgorithmType> ( "PMMUsingSPLITT__AbcPMM__AlgorithmType" )
    .derives<ParallelPruningAbcPMM::AlgorithmType::ParentType>( "PMMUsingSPLITT__AbcPMM__TraversalAlgorithm" )
  ;
  Rcpp::class_<ParallelPruningAbcPMM>( "PMMUsingSPLITT__AbcPMM" )
  .factory<Rcpp::List const&, vec const&>(&CreateParallelPruningAbcPMM)
  .method( "TraverseTree", &ParallelPruningAbcPMM::TraverseTree )
  .property( "algorithm", &ParallelPruningAbcPMM::algorithm )
  ;
}
```

Because I was using SPLITT mostly from an R-package, at present, there is only an R-package example. Even if you are not familiar with R, this guide should still help you understand how to use SPLITT from within your C++ program. 

## Installing the SPLITT R-package
I recommend installing the latest package version from github. From the R-prompt,
type the following command:

```{r, echo=TRUE, eval=FALSE}
devtools::install("./PMMUsingSPLITT-R-package")
```


```{r, echo=FALSE, eval=TRUE}
capture <- '✔  checking for file ‘/Users/vmitov/Documents/Bio/Projects/SPLITT/PMMUsingSPLITT-R-package/DESCRIPTION’ ...
─  preparing ‘PMMUsingSPLITT’:
✔  checking DESCRIPTION meta-information ...
─  cleaning src
─  checking for LF line-endings in source and make files and shell scripts
─  checking for empty or unneeded directories
─  building ‘PMMUsingSPLITT_1.0.tar.gz’
   Warning: invalid uid value replaced by that for user \'nobody\'
   
Running /Library/Frameworks/R.framework/Resources/bin/R CMD INSTALL \
  /var/folders/nb/_b5mkf753p3c86s9nrpk33gc002289/T//Rtmpk9L09F/PMMUsingSPLITT_1.0.tar.gz --install-tests 
* installing to library ‘/Users/vmitov/Library/R/3.5/library’
* installing *source* package ‘PMMUsingSPLITT’ ...
** libs
/usr/local/clang6/bin/clang++  -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -fopenmp -I"/Users/vmitov/Library/R/3.5/library/Rcpp/include" -I"/Users/vmitov/Library/R/3.5/library/RcppArmadillo/include" -I/usr/local/include   -fPIC  -Wall -g -O2  -c RCPP__AbcPMM.cpp -o RCPP__AbcPMM.o
/usr/local/clang6/bin/clang++  -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG -fopenmp -I"/Users/vmitov/Library/R/3.5/library/Rcpp/include" -I"/Users/vmitov/Library/R/3.5/library/RcppArmadillo/include" -I/usr/local/include   -fPIC  -Wall -g -O2  -c RcppExports.cpp -o RcppExports.o
/usr/local/clang6/bin/clang++ -dynamiclib -Wl,-headerpad_max_install_names -undefined dynamic_lookup -single_module -multiply_defined suppress -L/Library/Frameworks/R.framework/Resources/lib -L/usr/local/lib -o PMMUsingSPLITT.so RCPP__AbcPMM.o RcppExports.o -fopenmp -F/Library/Frameworks/R.framework/.. -framework R -Wl,-framework -Wl,CoreFoundation
installing to /Users/vmitov/Library/R/3.5/library/PMMUsingSPLITT/libs
** R
** tests
** byte-compile and prepare package for lazy loading
** help
*** installing help indices
** building package indices
** testing if installed package can be loaded
* DONE (PMMUsingSPLITT)
Reloading attached PMMUsingSPLITT'

cat(capture)
```

## See if it works on your computer
```{r}
library(PMMUsingSPLITT)
MiniBenchmark(N=10000, Ntests = 10)
```

